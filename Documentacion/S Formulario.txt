title IU 4 FormularioDatos 

actor Usuario
participant index.js
participant App.js
participant ViewRenderer.jsx
participant FormularioDatos.jsx
participant Firebase Auth
participant Firestore
participant react

App.js->ViewRenderer.jsx:<ViewRenderer\n  currentView={"formularioDatos"}\n  setCurrentView={setCurrentView}\n  currentUser={currentUser}\n  ... />
ViewRenderer.jsx->FormularioDatos.jsx:<FormularioDatos setCurrentView={setCurrentView} currentUser={currentUser} mode="create" />

== Carga de datos inicial ==
alt currentUser existe
    FormularioDatos.jsx->Firestore:getDoc("usuarios/{uid}")
    Firestore-->FormularioDatos.jsx:userDoc
    FormularioDatos.jsx->react:setFormData(data)
    Usuario<--FormularioDatos.jsx:Formulario prellenado
else
    Usuario<--FormularioDatos.jsx:Formulario vacío
end

alt Usuario llena formulario
    Usuario->FormularioDatos.jsx:onChange cada campo
    FormularioDatos.jsx->react:updateField()
    react-->FormularioDatos.jsx:actualizar estado
end

alt Usuario hace click en botón "Establecer datos" o "Actualizar datos"
    Usuario->FormularioDatos.jsx:onClick handleSubmit()
    FormularioDatos.jsx->FormularioDatos.jsx:saveData(isFirstTime)
    FormularioDatos.jsx->FormularioDatos.jsx:validateForm()

    alt Validación correcta
        FormularioDatos.jsx->Firestore:setDoc("usuarios/{uid}", datosCompletos + medidas)
        alt isFirstTime = false
            FormularioDatos.jsx->Firestore:addDoc("usuarios/{uid}/historial", medidas + notas)
            Firestore-->FormularioDatos.jsx:docRef
        else primera vez
            note right of FormularioDatos.jsx: No se guarda en historial
        end
        FormularioDatos.jsx->react:setCurrentView("menuPrincipal")
        Usuario<--FormularioDatos.jsx:Redirige a menú principal
    else Validación falla
        FormularioDatos.jsx->react:setError(mensaje)
        Usuario<--FormularioDatos.jsx:Ve mensaje de error
    end
end

alt Usuario hace click en "Cancelar"
    Usuario->FormularioDatos.jsx:onClick botón Cancelar
    FormularioDatos.jsx->react:setCurrentView("menuPrincipal")
    Usuario<--FormularioDatos.jsx:Redirige sin guardar
end
